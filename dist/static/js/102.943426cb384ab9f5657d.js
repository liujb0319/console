webpackJsonp([102],{HpMy:function(e,a,t){"use strict";var i=t("4YfN"),s=t.n(i),n=t("lQSI"),o=t("hsap"),l=t.n(o);a.a={props:{},created:function(){this.change(this.$route.path)},beforeMount:function(){this.load(this.$route.query.buildconfigName)},ready:function(){},data:function(){return{activeName:"first",value:"1",options2:[{value:"1",label:"操作"},{value:"2",label:"修改构建配置"},{value:"3",label:"编辑YAML"},{value:"4",label:"删除构建配置"}],sbuildName:"",saveflag:0,deleted:!1,envFirstLoaded:0,loaded:!1,haveError:!1,errorMessage:"",buildconfig:{},builds:[],data:{},postdata:{},tableData:[],envTableData:[]}},components:{},filters:{},methods:s()({load:function(){var e=this;e.activeName=e.$route.query.tab?e.$route.query.tab:"first",this.$ajax.get(this.$httpConfig.buildconfig_detail.replace("{projectName}",e.$route.params.disName).replace("{buildconfigName}",e.$route.query.buildconfigName)).then(function(a){"BuildConfig"===a.data.kind?e.buildconfig=a.data:e.buildconfig=null,e.$ajax.get(e.$httpConfig.buildconfigs.replace("{projectName}",e.$route.params.disName)).then(function(a){e.updateByServer(a.data.metadata.selfLink,e.$token,a.data.metadata.resourceVersion)}).catch(function(e){console.log(e)}),e.searchBuildHistory(e.$route.query.buildconfigName,function(a,t){e.builds=a.data.items,e.loaded=!0,e.setValueToPage(),e.updateByServer(a.data.metadata.selfLink+t.substring(1),e.$token,a.data.metadata.resourceVersion,"&")})}).catch(function(e){console.log(e)})},setValueToPage:function(){var e={},a=this.buildconfig;a&&(this.postdata=a,e.buildConfigName=a.metadata.name,e.creationTimestamp=this.timeago.format(a.metadata.creationTimestamp,"zh_CN"));var t=[];t=this.builds;var i=null;for(var s in t)i?l()(i.metadata.creationTimestamp).isBefore(t[s].metadata.creationTimestamp)&&(i=t[s]):i=t[s];i&&(e.latestBuildNo=i.metadata.annotations["openshift.io/build.number"]?"#"+i.metadata.annotations["openshift.io/build.number"]:i.metadata.name,e.latestBuildName=i.metadata.name,a||(e.buildConfigName=i.metadata.labels.buildconfig?i.metadata.labels.buildconfig:i.metadata.labels["openshift.io/build-config.name"],e.creationTimestamp=this.timeago.format(i.metadata.creationTimestamp,"zh_CN"))),this.tableData=[];var n=[];for(var o in t){var c=t[o];c&&n.push({buildNo:c.metadata.annotations["openshift.io/build.number"]?"#"+c.metadata.annotations["openshift.io/build.number"]:c.metadata.name,buildName:c.metadata.name,statusCd:c.status.phase,status:this.getStatus(c),creationTimestamp:this.timeago.format(c.metadata.creationTimestamp,"zh_CN"),sortDate:l()(c.metadata.creationTimestamp).unix()})}if(this.tableData=n.sort(this.compare),a){a.spec.source&&"Git"===a.spec.source.type&&(e.sourceRepo=a.spec.source.git.uri),a.spec.strategy&&("ImageStreamTag"!==a.spec.strategy.sourceStrategy.from.kind||a.spec.strategy.sourceStrategy.from.namespace&&a.metadata.namespace!==a.spec.strategy.sourceStrategy.from.namespace?("ImageStreamTag"!==a.spec.strategy.sourceStrategy.from.kind||a.spec.strategy.sourceStrategy.from.namespace&&a.metadata.namespace!==a.spec.strategy.sourceStrategy.from.namespace)&&(e.builderImage=a.spec.strategy.sourceStrategy.from.namespace+"/"+a.spec.strategy.sourceStrategy.from.name):e.builderImage=a.spec.strategy.sourceStrategy.from.namespace+"/"+a.spec.strategy.sourceStrategy.from.name),a.spec.output.to&&("ImageStreamTag"!==a.spec.output.to.kind||a.spec.output.to.namespace&&a.metadata.namespace!==a.spec.output.to.namespace?"ImageStreamTag"!==a.spec.output.to.kind&&a.spec.output.to.namespace&&a.metadata.namespace!==a.spec.output.to.namespace&&(e.builderImage=a.metadata.namespace+"/"+a.spec.output.to.name):e.outputTo=a.metadata.namespace+"/"+a.spec.output.to.name),a.spec.runPolicy&&(e.runPolicy=a.spec.runPolicy);var r={},u=this.$httpConfig.buildconfig_detail.replace("{projectName}",this.$route.params.disName).replace("{buildconfigName}",this.$route.query.buildconfigName);for(var d in a.spec.triggers)switch(a.spec.triggers[d].type){case"Bitbucket":r["Bitbucket Webhook:"]=this.getWebhookURL(u,a.spec.triggers[d].bitbucket.secret,"bitbucket");break;case"GitHub":r["GitHub Webhook:"]=this.getWebhookURL(u,a.spec.triggers[d].github.secret,"github");break;case"GitLab":r["GitLab Webhook:"]=this.getWebhookURL(u,a.spec.triggers[d].gitlab.secret,"gitlab");break;case"Generic":r["Generic Webhook:"]=this.getWebhookURL(u,a.spec.triggers[d].generic.secret,"generic");break;case"ImageChange":var m=a.spec.triggers[d].imageChange.from||a.spec.strategy.sourceStrategy.from;"ImageStreamTag"!==m.kind||m.namespace&&a.metadata.namespace!==m.namespace?("ImageStreamTag"!==m.kind||m.namespace&&a.metadata.namespace!==m.namespace)&&(r["新镜像:"]=(m.namespace||a.metadata.namespace)+"/"+m.name):r["新镜像:"]=(m.namespace||a.metadata.namespace)+"/"+m.name;break;case"ConfigChange":r["配置更改:"]="Build config "+a.metadata.name;break;default:r["其他Trigger:"]=a.spec.triggers[d].type}e.triggers=r,e.manualCLI="oc start-build "+a.metadata.name+" -n "+this.$route.params.disName;var p=a.spec.strategy.sourceStrategy.env;this.envTableData=[];for(var b in p)this.envTableData.push({envKey:p[b].name,envValue:p[b].value,class:"delete ml20"});this.envTableData.length>0||this.envTableData.push({envKey:"",envValue:"",class:"delete ml20"}),this.envFirstLoaded=0}this.$set(this,"data",e)},updateByServer:function(e,a,t,i){var s=this;i||(i="?");var n=this.$httpConfig.socketHost+e+i+"access_token="+a+"&watch=true&resourceVersion="+t,o=new WebSocket(n);o.onmessage=function(e){var a=JSON.parse(e.data);if(a.type&&"DELETED"===a.type)if("Build"===a.object.kind){for(var t in s.builds)if(s.builds[t].metadata.name===a.object.metadata.name){s.builds.splice(t,1);break}}else"BuildConfig"===a.object.kind&&s.buildconfig.metadata.name===a.object.metadata.name&&(s.deleted=!0);else if(a.type&&"MODIFIED"===a.type)if("Build"===a.object.kind){for(var t in s.builds)if(s.builds[t].metadata.name===a.object.metadata.name){s.builds[t].metadata=a.object.metadata,s.builds[t].spec=a.object.spec,s.builds[t].status=a.object.status;break}}else"BuildConfig"===a.object.kind&&s.buildconfig.metadata.name===a.object.metadata.name&&(s.buildconfig.metadata=a.object.metadata,s.buildconfig.spec=a.object.spec,s.buildconfig.status=a.object.status);else if(a.type&&"ADDED"===a.type&&"Build"===a.object.kind){var i=!1;for(var t in s.builds)if(s.builds[t].metadata.name===a.object.metadata.name){s.builds[t].metadata=a.object.metadata,s.builds[t].spec=a.object.spec,s.builds[t].status=a.object.status,i=!0;break}i||s.builds.push(a.object)}},o.onerror=function(e){console.log("[onerror]"),console.log(e)},o.onopen=function(e){console.log("[onopen]"),console.log(e)},o.onclose=function(){console.log("[onclose]")}},searchBuildHistory:function(e,a){var t=this,i="/?labelSelector=openshift.io/build-config.name="+e;t.$ajax.get(t.$httpConfig.builds.replace("{projectName}",t.$route.params.disName)+i).then(function(e){a(e,i)}).catch(function(e){console.log(e)})},getWebhookURL:function(e,a,t){return e+"/webhooks/"+a+"/"+t},getStatus:function(e){var a="";switch(e.status.phase){case"Complete":a="• 构建成功";break;case"Running":a="• 正在构建";break;case"Pending":a="• 构建等待中";break;case"Failed":a="• 构建失败";break;case"New":a="• 新建构建";break;case"Error":a="• 构建错误"}return a},compare:function(e,a){return a.sortDate-e.sortDate},buildsDetailClick:function(e,a,t,i){"构建编号"===a.label&&e.buildName&&this.$router.push({name:"构建构建历史",query:{buildName:e.buildName}})},latestLogClick:function(){this.data.latestBuildName&&this.$router.push({name:"构建构建历史",query:{buildName:this.data.latestBuildName,tab:"third"}})},buildClick:function(){if(this.deleted||!this.buildconfig)this.$notify.error({title:"错误",duration:0,message:"构建配置"+this.$route.query.buildconfigName+"已经被删除，无法构建。"});else{var e={},a=this;this.$ajax.get(this.$httpConfig.buildconfigs.replace("{projectName}",this.$route.params.disName)).then(function(t){e.apiVersion="BuildConfigList"===t.data.kind?t.data.apiVersion:"V1",e.kind="BuildRequest";var i={};i.name=a.$route.query.buildconfigName,e.metadata=i,a.$ajax.post(a.$httpConfig.buildconfig_instantiate.replace("{projectName}",a.$route.params.disName).replace("{buildconfigName}",a.$route.query.buildconfigName),e).then(function(e){a.$notify({title:"成功",message:"构建"+e.data.metadata.annotations["openshift.io/build-config.name"]+"#"+e.data.metadata.annotations["openshift.io/build.number"]+"已成功加入队列。",type:"success"}),a.load(a.$route.query.buildconfigName)}).catch(function(e){console.log(e)})}).catch(function(e){console.log(e)})}},searchClick:function(){var e=this;e.searchBuildHistory(e.$route.query.buildconfigName,function(a){var t=a.data.items;e.tableData=[];var i=[];for(var s in t){var n=t[s];!n||e.sbuildName!=n.metadata.name&&e.sbuildName||i.push({buildNo:n.metadata.annotations["openshift.io/build.number"]?"#"+n.metadata.annotations["openshift.io/build.number"]:n.metadata.name,buildName:n.metadata.name,statusCd:n.status.phase,status:e.getStatus(n),creationTimestamp:e.timeago.format(n.metadata.creationTimestamp,"zh_CN"),sortDate:l()(n.metadata.creationTimestamp).unix()})}e.tableData=i.sort(e.compare)})},addEnvClick:function(){this.envTableData.push({envKey:"",envValue:"",class:"delete ml20"})},saveEnvClick:function(){if(this.deleted)this.$notify.error({title:"错误",duration:0,message:"构建配置"+this.$route.query.buildconfigName+"已经被删除，无法修改。"});else{var e=[],a=this;for(var t in this.envTableData){var i={};i.name=this.envTableData[t].envKey,i.value=this.envTableData[t].envValue,i.name&&i.value&&e.push(i)}this.postdata.spec.strategy.sourceStrategy.env=e,this.$ajax.put(this.$httpConfig.buildconfig_detail.replace("{projectName}",this.$route.params.disName).replace("{buildconfigName}",this.$route.query.buildconfigName),this.postdata).then(function(e){a.saveflag=0,console.log("submited!"),console.log(e),a.$message({showClose:!0,duration:0,message:a.$route.query.buildconfigName+"已经被修改。",type:"success"})}).catch(function(e){console.log(e)})}},delEnvClick:function(e){0!==e?this.envTableData.splice(e,1):this.envTableData.length>1?this.envTableData.splice(e,1):(this.envTableData=[],this.envTableData.push({envKey:"",envValue:"",class:"delete ml20"}))},cancelClick:function(){this.load(this.$route.query.buildconfigName)},handleClick:function(e,a){},actionEvent:function(e){var a=this;if(2==e)this.deleted||!this.buildconfig?(this.$notify.error({title:"错误",duration:0,message:"构建配置"+this.$route.query.buildconfigName+"已经被删除，无法修改。"}),this.value="1"):this.$router.push({name:"构建修改构建",query:{buildconfigName:this.data.buildConfigName}});else if(3==e)this.$router.push({name:"编辑YAML",query:{estate:1,buildconfig:this.$route.query.buildconfigName}});else if(4==e){var t=this;this.haveError=!1,this.$confirm("此操作将永久删除构建配置"+this.$route.query.buildconfigName+", 是否继续?","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(function(){a.$ajax.delete(a.$httpConfig.buildconfig_detail.replace("{projectName}",t.$route.params.disName).replace("{buildconfigName}",t.$route.query.buildconfigName)).then(function(e){"Status"===e.data.kind&&"Failure"===e.data.status&&"200"!==e.data.code?(t.haveError=!0,t.errorMessage="此构建配置无法删除。原因："+e.data.message,t.value="1"):(t.$message({type:"success",message:"删除成功!"}),t.$router.go(-1))}).catch(function(e){t.value="1",e||t.$message({type:"error",message:"删除失败!"})})}).catch(function(){t.value="1",t.$message({type:"info",message:"已取消删除"})})}}},t.i(n.c)(["change"])),computed:{},watch:{builds:{handler:function(e){console.log("builds change"),this.builds&&this.builds.length>0&&this.buildconfig&&this.setValueToPage()},deep:!0},buildconfig:{handler:function(e){this.builds&&this.builds.length>0&&this.buildconfig&&this.setValueToPage()},deep:!0},envTableData:{handler:function(e){console.log("envTableData change"),0!==this.envFirstLoaded&&(this.saveflag=1);for(var a in e)if(!e[a].envKey&&e[a].envValue){this.saveflag=0;break}this.envFirstLoaded=1},deep:!0}}}},h8XC:function(e,a,t){"use strict";var i=function(){var e=this,a=e.$createElement,t=e._self._c||a;return e.loaded?t("div",[e.deleted?t("el-alert",{attrs:{title:"警告",type:"warning",description:"此构建已经被删除。","show-icon":""}}):e._e(),e._v(" "),e.haveError?t("el-alert",{attrs:{title:"错误",type:"error",description:e.errorMessage,"show-icon":""}}):e._e(),e._v(" "),e.buildconfig?e._e():t("el-alert",{attrs:{title:"错误",type:"error",description:"此构建已经被删除。","show-icon":""}}),e._v(" "),t("el-row",{staticClass:"detail-title",attrs:{justify:"space-between",align:"middle"}},[t("el-col",{attrs:{span:14}},[t("div",{staticClass:"f18"},[e._v(e._s(e.data.buildConfigName))]),e._v(" "),t("div",{staticClass:"mt10 f13 color6"},[e._v("基本信息")]),e._v(" "),e.builds.length>0?t("div",{staticClass:"mt10 f13 color6"},[t("span",[e._v("最新构建："+e._s(e.data.latestBuildNo))]),e._v(" "),t("span",{staticClass:"blue-color",on:{click:e.latestLogClick}},[e._v(" 最新构建日志")]),e._v(" "),t("span",{staticClass:"ml20"},[e._v("最新更新时间："+e._s(e.data.creationTimestamp))])]):t("div",{staticClass:"mt10 f13 color6"},[t("span",[e._v("最新更新时间："+e._s(e.data.creationTimestamp))])])]),e._v(" "),e.buildconfig?t("el-col",{staticClass:"  tr btn110 inner-element",staticStyle:{"margin-top":"20px"},attrs:{span:10}},[t("el-button",{attrs:{type:"primary"},on:{click:e.buildClick}},[e._v("开始构建")]),e._v(" "),t("div",{staticClass:"ml20 selectwh110"},[t("el-select",{attrs:{placeholder:"操作"},on:{change:function(a){e.actionEvent(e.value)}},model:{value:e.value,callback:function(a){e.value=a},expression:"value"}},e._l(e.options2,function(e){return t("el-option",{key:e.value,attrs:{label:e.label,value:e.value}})}))],1)],1):e._e()],1),e._v(" "),t("div",{staticClass:"mt20 "},[t("el-tabs",{on:{"tab-click":e.handleClick},model:{value:e.activeName,callback:function(a){e.activeName=a},expression:"activeName"}},[t("el-tab-pane",{attrs:{label:"构建历史",name:"first"}},[t("div",{staticClass:"mt20"},[t("el-row",[t("el-col",{staticClass:"input-btn",attrs:{span:24}},[t("el-input",{attrs:{placeholder:"按名称搜索 (构建名称-构建编号)"},model:{value:e.sbuildName,callback:function(a){e.sbuildName=a},expression:"sbuildName"}}),e._v(" "),t("el-button",{staticClass:"shade-button ml10",on:{click:e.searchClick}},[e._v("搜索")])],1)],1),e._v(" "),t("div",{staticClass:"mid-table mt20"},[t("el-table",{staticStyle:{width:"100%"},attrs:{data:e.tableData},on:{"cell-click":e.buildsDetailClick}},[t("el-table-column",{attrs:{prop:"buildNo",label:"构建编号",width:"150",align:"center","class-name":"blue-color"}}),e._v(" "),t("el-table-column",{attrs:{label:"状态",width:"150",align:"center"},scopedSlots:e._u([{key:"default",fn:function(a){return["Complete"===a.row.statusCd?t("i",{staticClass:"el-icon-check icon-small"}):"Failed"===a.row.statusCd?t("i",{staticClass:"el-icon-close icon-small"}):"Error"===a.row.statusCd?t("i",{staticClass:"el-icon-close icon-small"}):t("i",{staticClass:"el-icon-loading icon-small"}),e._v(" "),t("span",{staticClass:"ml10 ",class:{"success-staus":"Complete"==a.row.statusCd,"fail-staus":"Failed"==a.row.statusCd,"fail-staus":"Error"==a.row.statusCd,"active-staus":"Running"==a.row.statusCd,"waitfor-status":"New"==a.row.statusCd,"waitfor-status":"Pending"==a.row.statusCd}},[e._v("\n                          "+e._s(a.row.status)+"\n                      ")])]}}])}),e._v(" "),t("el-table-column",{attrs:{prop:"creationTimestamp",label:"创建时间",align:"center"}})],1)],1)],1)]),e._v(" "),e.buildconfig?t("el-tab-pane",{attrs:{label:"构建配置",name:"second"}},[t("el-row",{staticClass:"mt20"},[t("el-col",{staticClass:"build-el"},[t("div",{staticClass:"build-eltop"},[e._v("配置")]),e._v(" "),t("div",{staticClass:"build-elcon"},[t("div",[t("span",{staticClass:"dede"},[e._v("代码源：")]),e._v(" "),t("span",[e._v(e._s(e.data.sourceRepo))])]),e._v(" "),t("div",[t("span",[e._v("构建镜像：")]),e._v(" "),t("span",[e._v(e._s(e.data.builderImage))])]),e._v(" "),t("div",[t("span",[e._v("应用镜像：")]),e._v(" "),t("span",[e._v(e._s(e.data.outputTo))])]),e._v(" "),t("div",[t("span",[e._v("运行策略：")]),e._v(" "),t("span",[e._v(e._s(e.data.runPolicy))])])])]),e._v(" "),t("el-col",{staticClass:"ml20 build-el"},[t("div",{staticClass:"build-eltop"},[e._v("触发")]),e._v(" "),t("div",{staticClass:"build-elcon build-elcon1"},[e._l(e.data.triggers,function(a,i){return t("div",[-1!==i.indexOf("Webhook")?t("div",[t("div",[t("span",[e._v(e._s(i))])]),e._v(" "),t("div",[t("span",[e._v(e._s(a))])])]):t("div",[t("div",[t("span",[e._v(e._s(i))]),e._v(" "),t("span",[e._v(e._s(a))])])])])}),e._v(" "),t("div",[t("span",[e._v("手工CLI命令：")]),e._v(" "),t("span",[e._v(e._s(e.data.manualCLI))])])],2)])],1)],1):e._e(),e._v(" "),e.buildconfig?t("el-tab-pane",{attrs:{label:"环境变量",name:"third"}},[e._l(e.envTableData,function(a,i){return t("el-row",{staticClass:"inner-element mt10"},[t("div",[e._v("环境变量：")]),e._v(" "),t("div",{staticClass:"wh350 ml10"},[t("el-input",{model:{value:a.envKey,callback:function(e){a.envKey=e},expression:"item.envKey"}})],1),e._v(" "),t("div",{staticClass:"wh350 ml20"},[t("el-input",{model:{value:a.envValue,callback:function(e){a.envValue=e},expression:"item.envValue"}})],1),e._v(" "),t("div",{staticClass:"pluse ml20",on:{click:function(a){e.addEnvClick()}}},[e._v(" + ")]),e._v(" "),t("div",{class:a.class,on:{click:function(a){e.delEnvClick(i)}}},[e._v(" × ")])])}),e._v(" "),0==e.saveflag?t("div",{staticClass:"btn110 mt40 ml85"},[t("el-button",{attrs:{type:"primary",disabled:""}},[e._v(" 保存 ")]),e._v(" "),t("el-button",{on:{click:function(a){e.cancelClick()}}},[e._v(" 取消 ")])],1):t("div",{staticClass:"btn110 mt40 ml85"},[t("el-button",{attrs:{type:"primary"},on:{click:function(a){e.saveEnvClick()}}},[e._v(" 保存 ")]),e._v(" "),t("el-button",{on:{click:function(a){e.cancelClick()}}},[e._v(" 取消 ")])],1)],2):e._e()],1)],1)],1):t("div",[e._m(0)])},s=[function(){var e=this,a=e.$createElement,t=e._self._c||a;return t("div",{staticStyle:{"text-align":"center","line-height":"250px"}},[t("i",{staticClass:"el-icon-loading",staticStyle:{"font-size":"20px"}}),t("span",[e._v(" 加载中······")])])}],n={render:i,staticRenderFns:s};a.a=n},miag:function(e,a,t){"use strict";function i(e){t("qrPl")}Object.defineProperty(a,"__esModule",{value:!0});var s=t("HpMy"),n=t("h8XC"),o=t("J0+h"),l=i,c=o(s.a,n.a,l,"data-v-363b365c",null);a.default=c.exports},qrPl:function(e,a,t){var i=t("zA7e");"string"==typeof i&&(i=[[e.i,i,""]]),i.locals&&(e.exports=i.locals);t("XkoO")("2e6c1cee",i,!0)},zA7e:function(e,a,t){a=e.exports=t("YfG4")(!1),a.push([e.i,".build-el[data-v-363b365c]{border:1px solid #e5e5e5;width:48%}.build-el .build-eltop[data-v-363b365c]{background:-webkit-gradient(linear,left top,left bottom,from(#f7f7f7),to(#fff));background:linear-gradient(180deg,#f7f7f7,#fff);height:35px;line-height:35px;text-align:center;border-bottom:1px solid #e5e5e5}.build-el .build-elcon[data-v-363b365c]{padding:20px}.build-el .build-elcon.build-elcon1[data-v-363b365c]{padding-top:10px}.build-el .build-elcon div span[data-v-363b365c]{line-height:2}.width70[data-v-363b365c]{width:70px}.el-icon-check[data-v-363b365c]{font-size:10px;color:#228b22}.el-icon-close[data-v-363b365c]{font-size:10px;color:#ea0000}",""])}});