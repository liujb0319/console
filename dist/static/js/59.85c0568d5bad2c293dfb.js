webpackJsonp([59],{"3cXf":function(e,t,a){e.exports={default:a("I4CF"),__esModule:!0}},"5guv":function(e,t,a){"use strict";function s(e){a("kcUH")}Object.defineProperty(t,"__esModule",{value:!0});var i=a("cXnX"),o=a("9uKd"),n=a("J0+h"),l=s,c=n(i.a,o.a,l,"data-v-79faa686",null);t.default=c.exports},"9uKd":function(e,t,a){"use strict";var s=function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",[a("div",{staticClass:"content-title "},[e._v(" 修改构建")]),e._v(" "),e.loaded?a("div",{staticClass:"content-container"},[a("div",{staticClass:"mt20 revise-item"},[a("div",{staticClass:"f16"},[e._v(" 代码仓库设置")]),e._v(" "),a("div",{staticClass:"mt20"},[a("el-row",{attrs:{align:"middle"}},[a("el-col",{staticClass:"left mt10",attrs:{span:2}},[e._v("代码仓库源：")]),e._v(" "),a("el-col",{attrs:{span:14}},[a("el-input",{staticClass:"search-input",attrs:{placeholder:""},model:{value:e.showData.sourceType,callback:function(t){e.showData.sourceType=t},expression:"showData.sourceType"}})],1)],1),e._v(" "),a("el-row",{staticClass:"mt20",attrs:{align:"middle"}},[a("el-col",{staticClass:"left mt10",attrs:{span:2}},[e._v("代码仓库URL：")]),e._v(" "),a("el-col",{attrs:{span:14}},[a("el-input",{staticClass:"search-input",attrs:{placeholder:""},model:{value:e.showData.gitUri,callback:function(t){e.showData.gitUri=t},expression:"showData.gitUri"}})],1)],1),e._v(" "),a("el-row",{staticClass:"mt20",attrs:{align:"middle"}},[a("el-col",{staticClass:"left mt10",attrs:{span:2}},[e._v("代码分支：")]),e._v(" "),a("el-col",{attrs:{span:14}},[a("el-input",{staticClass:"search-input",attrs:{placeholder:""},model:{value:e.showData.gitRef,callback:function(t){e.showData.gitRef=t},expression:"showData.gitRef"}})],1)],1),e._v(" "),a("el-row",{staticClass:"mt20",attrs:{align:"middle"}},[a("el-col",{staticClass:" left mt10",attrs:{span:2}},[e._v("构建目录：")]),e._v(" "),a("el-col",{attrs:{span:14}},[a("el-input",{staticClass:"search-input",attrs:{placeholder:"/"},model:{value:e.showData.contextDir,callback:function(t){e.showData.contextDir=t},expression:"showData.contextDir"}})],1)],1),e._v(" "),a("el-row",{staticClass:"mt20 last",attrs:{align:"middle"}},[a("el-col",{staticClass:" left mt10",attrs:{span:2}},[e._v("私密凭据：")]),e._v(" "),a("el-col",{attrs:{span:14}},[a("el-select",{staticClass:"wh350",model:{value:e.sourceSecret,callback:function(t){e.sourceSecret=t},expression:"sourceSecret"}},e._l(e.secretsOptions,function(e){return a("el-option",{key:e.key,attrs:{label:e.name,value:e.name}})})),e._v(" "),a("el-button",{staticClass:"ml10",on:{click:e.createSecretClick}},[e._v("创建私密凭据")])],1)],1)],1)]),e._v(" "),a("div",{staticClass:"mt20 revise-item"},[a("div",{staticClass:"f16"},[e._v(" 镜像设置")]),e._v(" "),a("div",{staticClass:"mt20"},[a("el-row",{attrs:{align:"middle"}},[a("el-col",{staticClass:"f16 red-star width53"},[e._v("镜像：")]),e._v(" "),a("el-col",{staticClass:"ml10",attrs:{span:6}},[a("el-radio",{staticClass:"radio",attrs:{label:"1"},model:{value:e.imageKind,callback:function(t){e.imageKind=t},expression:"imageKind"}},[e._v("私有镜像")]),e._v(" "),a("el-radio",{staticClass:"radio",attrs:{label:"2"},model:{value:e.imageKind,callback:function(t){e.imageKind=t},expression:"imageKind"}},[e._v("共有镜像")])],1)],1),e._v(" "),a("div",{directives:[{name:"show",rawName:"v-show",value:"1"==e.imageKind,expression:"imageKind=='1'"}]},[a("el-row",{staticClass:"mt20",attrs:{align:"middle"}},[a("el-col",{staticClass:" left2 mt10"},[e._v("项目：")]),e._v(" "),a("el-select",{staticClass:"wh350",attrs:{placeholder:"项目"},on:{change:function(t){e.projectSelClick(e.project)}},model:{value:e.project,callback:function(t){e.project=t},expression:"project"}},e._l(e.projectsOptions,function(e){return a("el-option",{key:e.key,attrs:{label:e.name,value:e.name}})}))],1),e._v(" "),a("el-row",{staticClass:"mt20",attrs:{align:"middle"}},[a("el-col",{staticClass:" left2 mt10"},[e._v("私有镜像名称：")]),e._v(" "),a("el-select",{staticClass:"wh350",attrs:{placeholder:"私有镜像名称"},on:{change:function(t){e.imageSelClick(e.image)}},model:{value:e.image,callback:function(t){e.image=t},expression:"image"}},e._l(e.imagesOptions,function(e){return a("el-option",{key:e.key,attrs:{label:e.name,value:e.name}})}))],1),e._v(" "),a("el-row",{staticClass:"mt20",attrs:{align:"middle"}},[a("el-col",{staticClass:" left2 mt10"},[e._v("版本：")]),e._v(" "),a("el-select",{staticClass:"wh350",attrs:{placeholder:"版本"},model:{value:e.version,callback:function(t){e.version=t},expression:"version"}},e._l(e.imageVersionsOptions,function(e){return a("el-option",{key:e.key,attrs:{label:e.name,value:e.name}})}))],1)],1),e._v(" "),a("div",{directives:[{name:"show",rawName:"v-show",value:"2"==e.imageKind,expression:"imageKind=='2'"}]},[a("el-row",{staticClass:"mt20",attrs:{align:"middle"}},[a("el-col",{staticClass:" left2 mt10"},[e._v("镜像名称：")]),e._v(" "),a("el-col",{staticClass:"wh350"},[a("el-input",{attrs:{placeholder:" ",icon:"search","on-icon-click":e.handleIconClick},model:{value:e.publicImage,callback:function(t){e.publicImage=t},expression:"publicImage"}})],1)],1)],1)],1)]),e._v(" "),a("div",{staticClass:"mt20 revise-item"},e._l(e.envTableData,function(t,s){return a("el-row",{staticClass:"inner-element mt10"},[a("div",{staticClass:" wh70 mt10"},[e._v("环境变量：")]),e._v(" "),a("div",{staticClass:"wh350 ml10"},[a("el-input",{model:{value:t.envKey,callback:function(e){t.envKey=e},expression:"item.envKey"}})],1),e._v(" "),a("div",{staticClass:"wh350 ml20"},[a("el-input",{model:{value:t.envValue,callback:function(e){t.envValue=e},expression:"item.envValue"}})],1),e._v(" "),a("div",{staticClass:"pluse ml20",on:{click:function(t){e.addEnvClick()}}},[e._v(" + ")]),e._v(" "),a("div",{class:t.class,on:{click:function(t){e.delEnvClick(s)}}},[e._v(" × ")])])})),e._v(" "),a("div",{staticClass:"mt20 revise-item"},[a("div",{staticClass:"f16"},[e._v("构建设置")]),e._v(" "),a("div",{staticClass:"mt20"},[a("el-checkbox",{staticClass:"f12",model:{value:e.imageChangeBuild,callback:function(t){e.imageChangeBuild=t},expression:"imageChangeBuild"}},[e._v("当构建镜像更新后，自动构建新的应用镜像")]),e._v(" "),a("el-row",{staticClass:"mt10",attrs:{align:"middle"}},[a("el-col",{staticClass:"wh100"},[e._v("构建执行策略：")]),e._v(" "),a("el-col",{staticClass:"ml10",attrs:{span:12}},[a("el-radio",{staticClass:"radio",attrs:{label:"Serial"},model:{value:e.runPolicy,callback:function(t){e.runPolicy=t},expression:"runPolicy"}},[e._v("顺序")]),e._v(" "),a("el-radio",{staticClass:"radio",attrs:{label:"Parallel"},model:{value:e.runPolicy,callback:function(t){e.runPolicy=t},expression:"runPolicy"}},[e._v("并行")]),e._v(" "),a("el-radio",{staticClass:"radio",attrs:{label:"SerialLatestOnly"},model:{value:e.runPolicy,callback:function(t){e.runPolicy=t},expression:"runPolicy"}},[e._v("顺序执行最新构建")])],1)],1)],1)]),e._v(" "),a("el-row",{staticClass:"btn110 mt40 ml20",attrs:{align:"middle"}},[a("el-button",{attrs:{type:"primary"},on:{click:e.saveClick}},[e._v(" 确定 ")]),e._v(" "),a("el-button",{on:{click:e.cancelClick}},[e._v(" 取消 ")])],1)],1):a("div",[e._m(0)])])},i=[function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("div",{staticStyle:{"text-align":"center","line-height":"250px"}},[a("i",{staticClass:"el-icon-loading",staticStyle:{"font-size":"20px"}}),a("span",[e._v(" 加载中······")])])}],o={render:s,staticRenderFns:i};t.a=o},I4CF:function(e,t,a){var s=a("0nnt"),i=s.JSON||(s.JSON={stringify:JSON.stringify});e.exports=function(e){return i.stringify.apply(i,arguments)}},cXnX:function(e,t,a){"use strict";var s=a("3cXf"),i=a.n(s),o=a("4YfN"),n=a.n(o),l=a("lQSI"),c=a("VUvn");t.a={props:{},created:function(){this.change(this.$route.path)},ready:function(){},beforeMount:function(){this.load()},data:function(){return{testtest:!1,showData:{},postData:{},socketBuildconfig:{},imageChangeBuild:!1,project:"",image:"",version:"",imageKind:"",firstLoad:0,loaded:!1,submited:!1,belong:"1",radio:"1",runPolicy:"",sourceSecret:"",secretsOptions:[],projectsOptions:[],imagesOptions:[],imageVersionsOptions:[],publicImage:"",envTableData:[]}},components:{ElCol:c.a},filters:{},methods:n()({},a.i(l.c)(["change"]),{load:function(){var e=this;this.$ajax.get(this.$httpConfig.buildconfig_detail.replace("{projectName}",e.$route.params.disName).replace("{buildconfigName}",e.$route.query.buildconfigName)).then(function(t){e.$ajax.get(e.$httpConfig.buildconfigs.replace("{projectName}",e.$route.params.disName)).then(function(t){e.updateByServer(t.data.metadata.selfLink,e.$token,t.data.metadata.resourceVersion)}).catch(function(e){console.log(e)}),e.loaded=!0;var a=t.data;if(e.postData=t.data,e.showData.sourceType=a.spec.source.type,e.showData.gitUri=a.spec.source.git.uri,e.showData.gitRef=a.spec.source.git.ref,e.showData.contextDir=a.spec.source.contextDir,e.sourceSecret=a.spec.source.sourceSecret?a.spec.source.sourceSecret.name:"",e.showData.pitGroup={},"ImageStreamTag"===a.spec.strategy.sourceStrategy.from.kind){e.imageKind="1",e.project=a.spec.strategy.sourceStrategy.from.namespace,e.getImagesAndTagsByProject(e.project);var s=a.spec.strategy.sourceStrategy.from.name.split(":");e.image=s[0],e.version=s[1]}else e.publicImage=a.spec.strategy.sourceStrategy.from.name,a.spec.strategy.sourceStrategy.from.namespace&&(e.publicImage=a.spec.strategy.sourceStrategy.from.namespace+"/"+e.publicImage);var i=a.spec.strategy.sourceStrategy.env;for(var o in i)e.envTableData.push({envKey:i[o].name,envValue:i[o].value,class:"delete ml20"});e.envTableData.length>0||e.envTableData.push({envKey:"",envValue:"",class:"delete-default ml20"}),e.runPolicy=a.spec.runPolicy,e.$ajax.get(e.$httpConfig.secrets.replace("{projectName}",e.$route.params.disName)).then(function(t){var a=t.data.items;for(var s in a)if("kubernetes.io/basic-auth"===a[s].type||"kubernetes.io/ssh-auth"===a[s].type){var i={};i.key="secret",i.name=a[s].metadata.name,e.secretsOptions.push(i)}}).catch(function(e){console.log(e)}),e.$ajax.get(e.$httpConfig.projects).then(function(t){var a=t.data.items;for(var s in a){var i={};i.key="project",i.name=a[s].metadata.name,e.projectsOptions.push(i)}var o={};o.key="project",o.name="openshift",e.projectsOptions.push(o)}).catch(function(e){console.log(e)}),console.log(a.spec.triggers);for(var o in a.spec.triggers)"ImageChange"===a.spec.triggers[o].type&&(e.imageChangeBuild=!0)}).catch(function(e){console.log(e)})},updateByServer:function(e,t,a){var s=this,i=this.$httpConfig.socketHost+e+"?access_token="+t+"&watch=true&resourceVersion="+a;console.log(i);var o=new WebSocket(i);o.onmessage=function(e){console.log("[buildconfigs-onmessage]");var t=JSON.parse(e.data);if(t.type&&"DELETED"===t.type){if("BuildConfig"===t.object.kind)for(var a in s.buildconfigs)if(s.buildconfig.metadata.name===t.object.metadata.name){s.deleted=!0;break}}else t.type&&"MODIFIED"===t.type&&"BuildConfig"===t.object.kind&&s.postData.metadata.name===t.object.metadata.name&&(s.$set(s.socketBuildconfig,"metadata",t.object.metadata),s.$set(s.socketBuildconfig,"spec",t.object.spec),s.$set(s.socketBuildconfig,"status",t.object.status))},o.onerror=function(e){console.log("[onerror]"),console.log(e)},o.onopen=function(e){console.log("[onopen]"),console.log(e)},o.onclose=function(){console.log("[onclose]")}},getImagesAndTagsByProject:function(e){console.log("getImagesAndTagsByProject");var t=this;this.showData.pitGroup[e]?this.imagesOptions=this.showData.pitGroup[e]:(console.log("pitGroup is null"),this.$ajax.get(this.$httpConfig.images.replace("{projectName}",e)).then(function(a){console.log("ajax is done"),t.imagesOptions=[];var s=a.data.items;for(var i in s){var o={};o.key="image",o.name=s[i].metadata.name;var n=[];for(var l in s[i].status.tags){var c={};c.key="tag",c.name=s[i].status.tags[l].tag,n.push(c)}o.tag=n,t.imagesOptions.push(o)}t.showData.pitGroup[e]=t.imagesOptions,t.imageSelClick(t.image),t.firstLoad=1}).catch(function(e){console.log(e)}))},handleIconClick:function(){},createSecretClick:function(){this.$router.push({name:"创建私密凭据"})},projectSelClick:function(e){console.log("projectSelClick"),0!==this.firstLoad&&(this.image="",this.version=""),this.getImagesAndTagsByProject(e)},imageSelClick:function(e){0!==this.firstLoad&&(this.version="");for(var t in this.imagesOptions)if(this.imagesOptions[t].name===e){this.imageVersionsOptions=this.imagesOptions[t].tag;break}},saveClick:function(){if(console.log(i()(this.postData)),this.deleted)this.$notify.error({title:"错误",duration:0,message:"构建配置"+this.buildconfig.metadata.name+"已经被其他人删除，无法修改。"});else if(this.socketBuildconfig&&this.socketBuildconfig.metadata)this.$notify.error({title:"错误",duration:0,message:"构建配置"+this.socketBuildconfig.metadata.name+"已经被其他人修改，请重新加载后修改。"});else{if(this.postData.spec.source&&(this.postData.spec.source.type=this.showData.sourceType,this.postData.spec.source.git.uri=this.showData.gitUri,this.postData.spec.source.git.ref=this.showData.gitRef,this.postData.spec.source.contextDir=this.showData.contextDir,this.sourceSecret))if(this.postData.spec.source.sourceSecret)this.postData.spec.source.name=this.sourceSecret;else{var e={};e.name=this.sourceSecret,this.postData.spec.source.sourceSecret=e}var t={};"1"===this.imageKind?(t.kind="ImageStreamTag",t.namespace=this.project,t.name=this.image+":"+this.version):this.publicImage&&-1!==this.publicImage.indexOf("@")?(t.kind="ImageStreamImage",-1!==this.publicImage.indexOf("/")?(t.namespace=this.publicImage.split("/")[0],t.name=this.publicImage.split("/")[1]):(t.namespace=this.postData.metadata.namespace,t.name=this.publicImage)):(t.kind="DockerImage",t.name=this.publicImage),this.postData.spec.strategy.sourceStrategy.from=t;var a=[];for(var s in this.envTableData){var o={};o.name=this.envTableData[s].envKey,o.value=this.envTableData[s].envValue,o.name&&o.value&&a.push(o)}this.postData.spec.strategy.sourceStrategy.env=a;var n=!1;if(this.imageChangeBuild){for(var s in this.postData.spec.triggers)"ImageChange"===this.postData.spec.triggers[s].type&&(n=!0);if(!n){var l={};l.type="ImageChange",l.imageChange={},this.postData.spec.triggers.push(l)}}else for(var s in this.postData.spec.triggers)"ImageChange"===this.postData.spec.triggers[s].type&&this.postData.spec.triggers.splice(s,1);this.postData.spec.runPolicy=this.runPolicy,console.log(i()(this.postData));var c=this;this.$ajax.put(this.$httpConfig.buildconfig_detail.replace("{projectName}",this.$route.params.disName).replace("{buildconfigName}",this.postData.metadata.name),this.postData).then(function(e){c.submited=!0,c.$notify({title:"构建配置"+e.data.metadata.name+"已修改成功。",message:"",type:"success"}),c.$router.push({name:"构建项目详情",query:{buildconfigName:e.data.metadata.name}})}).catch(function(e){console.log(e)})}},cancelClick:function(){this.$router.go(-1)},addEnvClick:function(){this.envTableData.push({envKey:"",envValue:"",class:"delete ml20"})},delEnvClick:function(e){0!==e?this.envTableData.splice(e,1):this.envTableData.length>1?this.envTableData.splice(e,1):(this.envTableData=[],this.envTableData.push({envKey:"",envValue:"",class:"delete ml20"}))}}),computed:{},watch:{deleted:function(e){e&&this.$notify({title:"警告",duration:0,message:"此构建配置已经被删除。",type:"warning"})},socketBuildconfig:{handler:function(e){console.log("socketBuildconfig change"),e.metadata&&e.spec&&e.status&&e.metadata.name===this.$route.query.buildconfigName&&!this.submited&&this.$notify({title:"警告",duration:0,message:"构建配置"+this.socketBuildconfig.metadata.name+"已经被其他人修改，请重新加载后修改。",type:"warning"})},deep:!0}}}},kcUH:function(e,t,a){var s=a("rT2V");"string"==typeof s&&(s=[[e.i,s,""]]),s.locals&&(e.exports=s.locals);a("XkoO")("de31fd8a",s,!0)},rT2V:function(e,t,a){t=e.exports=a("YfG4")(!1),t.push([e.i,".revise-item[data-v-79faa686]{border-top:1px dashed #e5e5e5;padding-top:15px}.left[data-v-79faa686]{width:110px;text-align:right;margin-right:10px}.left2[data-v-79faa686]{width:120px;text-align:right;margin-right:10px}.ww[data-v-79faa686]{width:100%}.width53[data-v-79faa686]{width:53px}.width70[data-v-79faa686]{width:70px}",""])}});